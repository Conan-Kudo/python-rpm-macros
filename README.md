# Multi-Python, Single-Spec macro system

This repository contains a work-in-progress macro system generator for the singlespec python initiative.

### Dictionary

__flavor__ is a kind of python interpreter. At this point, we recognize the following flavors: `python2`, `python3` and `pypy`.
Flavors also have short names: `py2` for Python 2, `py3` for Python 3, `pypy` for PyPy.

For reasons of compatibility and also confusion, in many places, the `python2` flavor is called `python`. This will be resolved in time. `python` is intended to be an alias for "currently preferred flavor". It will be switched to mean `python3` in the future.

__modname__ is the PyPI name, or, if the package in question is not on PyPI, the moniker that we chose to stand in for it.

Packages adhering to the SUSE Python module naming policy are usually called `%{flavor}-%{modname}`. In some cases, it is only `%{modname}` though.

__pkgname__, or __subpackage name__, is internal to a spec file, and is that thing you put after the `%package` macro. Pkgname of the package itself is an empty string. Pkgname of a `%package -n something` is at this point `-n something`, which is not very meaningful. This is a TODO item.

The purpose of the singlespec system is to take a package called `%{flavor}-%{modname}` for a particular flavor, and autogenerate subpackages `%{flavor}-%{modname}` for all the other flavors.

### Macros

The following macros are considered public API:

__`%pythons`__ - list of flavors we are building for.

__`%have_python`, `%have_python3`, `%have_pypy`__. Defined as 1 if we are building for that flavor, 0 otherwise. (TODO: %have_python should be %have_python2)

__`%{python_buildrequire modname}`__ expands to `BuildRequires: $flavor-modname` for every flavor in `%pythons`.
__`%{python_module modname [= version]}`__ expands to `$flavor-modname [= version]` for every flavor. Intended as: `BuildRequires: %{python_module foo}`.  
These two are interchangeable. One will be dropped.

__`%ifpython2`, `%ifpython3`, `%ifpypy`__: applies the following section only to subpackages of that particular flavor.

__`%py2_only`, `%py3_only`, `%pypy_only`__: applies the contents of the line only to subpackages of that particular flavor.

__`%python_build`__ expands to `$flavor setup.py build` for all flavors.

__`%python_install`__ expands to `$flavor setup.py install --root=%{buildroot}` for all flavors.

__`%python_exec something.py`__ expands to `$flavor something.py` for all flavors, and moves around the distutils-generated `build` directory so that you are never running python2 script with a python3-generated `build`. This is only useful for distutils/setuptools. `%python_exec` may gain more abilities in the future.

__`%py2_build`, `%py3_build`, `%pypy_build`__ expands to`$flavor setup.py build` for the particular flavor.  
__`%py2_install`, `%py3_install`, `%pypy_install`__ expands to`$flavor setup.py install --root(...)` for the particular flavor.  
This is mostly for Fedora compatibility.

__`%python_subpackages`__ expands to the autogenerated subpackages. This should go after your `%description` section.

Alternative-related, general:

__`%prepare_alternative [-t <targetfile> ] <name>`__  
replaces `<targetfile>` with a symlink to `/etc/alternatives/<name>`, plus related housekeeping. If no `<targetfile>` is given, it is `%{_bindir}/<name>`.

__`%install_alternative [-n ]<name> [-s <sourcefile>] [-t ]<targetfile> [-p ]<priority>`__  
runs the `update-alternative` command, configuring `<sourcefile>` alternative to be `<targetfile>`, with a priority `<priority>`. If no `<sourcefile>` is given, it is `%{_bindir}/<name>`.  
Can be followed by additional arguments to `update-alternatives`, such as `--slave`.

__`%uninstall_alternative [-n ]<name> [-t ]<targetfile>`__  
if uninstalling (not upgrading) the package, remove `<targetfile>` from a list of alternatives under `<name>`

Alternative-related, for Python:

__`%python_alternative <name>`__: expands to a filelist entries for `%{_bindir}/<name>`, the `/etc/alternatives/<name>` symlink, and the target called `%{_bindir}/<name>-%{py_ver}` (or $flavor_ver respectively).

__`%python_install_alternative <name>`__: runs `update-alternatives` for  `<name>-%{py_ver}`.

__`%python_uninstall_alternative <name>`__: reverse of the preceding.

These are called `python` for python2 and `python3` for python3. Don't exist for pypy yet, not the least because it's unclear what the pypy alternative executables should be called. Also a distinct python2 version should exist, so that "python" can remain generic.


### Files in repository

__`macros.in`__: 
The main macros file. Contains pure-RPM-macro definitions, references and usages of the private Lua macros.  
The line `### LUA-MACROS ###` is replaced with inlined Lua macro definitions.

__`macros.lua`__: Lua macro definitions. This is actually pseudo-Lua: the top-level functions are not functions, and are instead converted to Lua macro snippets. (That means that you can't call the top-level functions from Lua, and that you need to place actual Lua functions inside a snippet, preferably the `_scan_spec()` snippet.)  

__`embed-macros.pl`__: Takes care of slash-escaping and wrapping the Lua functions and inserting them into the `macros.in` file in order to generate the resulting macros.

__`apply-macros.sh`__: Generates macros file and then runs `rpmspec` against its first argument, using the generated macros. Useful for examining what is going on with your spec file.

__`install-macros.sh`__: Generates macros file and places it into prjconf of a given OBS project. __Beware:__ this overwrites original prjconf contents.

__`process-spec.pl`__: Simple regexp-based converter into the singlespec format.

__`README.md`__: This file. As if you didn't know.
